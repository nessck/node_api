stages:
- build_production
- build_uat
- test

image:
    name: docker/compose:latest
services:
- docker:dind
before_script:
- docker version
- docker-compose version

build_uat:
    stage: build
    script:
    - docker build -t nodejs .
    - docker-compose up -d
test:
    stage: test
    script :
    - docker build -t nodejs .
    - docker-compose up -d
    - sleep 5
    - docker exec postgres psql -U postgres -h postgres -f home/dumps/tests/medium.sql
    - docker exec myimage npx jasmine spec/api.spec.js spec/*.js
    - docker-compose down
only:
    - master
    when: manual

build_production:
    stage: build
    script:
    - docker build -t nodejs .
    - docker-compose up -d
test:
    stage: test
    script :
    - docker build -t nodejs .
    - docker-compose up -d
    - sleep 5
    # docker exec postgres psql -U postgres -h postgres -f home/dumps/tests/medium.sql
    # docker exec myimage npx jasmine spec/api.spec.js spec/*.js
    # docker-compose down
only:
    - master
    when: manual